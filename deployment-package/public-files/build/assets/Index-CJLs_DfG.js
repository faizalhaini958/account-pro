import{r as m,u as U,i as $,j as e,H as G}from"./app-De9YtYVO.js";import{D as J}from"./DashboardLayout-DB0kk3mn.js";import{D as K}from"./data-table-D4pKVaNe.js";import{getColumns as W}from"./columns-Cx9ofqqm.js";import{B as p,a as k}from"./index-sqIKGjOx.js";import{D as X,a as Y,b as Z,c as ee,d as se,e as ae,f as te}from"./dialog-B_EPHwqc.js";import{I as C}from"./input-YJ4y34zb.js";import{L as o}from"./label-BNYjQoyA.js";import{T as ne}from"./textarea-BrFMof27.js";import{S,a as w,b as D,c as T,d as l}from"./select-B2rqhBdx.js";import{P as re,a as le,b as ie,C as oe}from"./calendar-DDO4Otf0.js";import{f as u}from"./format-D9s8ZFBe.js";import{T as ce,a as de,b as P,c as j,d as me,e as f}from"./table-3xAxy9mO.js";import{u as xe}from"./useTranslation-CmIvGiqX.js";import{P as he}from"./plus-DIUrj948.js";import{C as pe}from"./calendar-DaZVa6bq.js";import{L as ue}from"./loader-circle-DjIWaf7f.js";import{f as A}from"./format-BS8Ay9AX.js";import"./toaster-CljvMPLZ.js";import"./Combination-Dy-FKPUP.js";import"./dropdown-menu-BBgrL1DT.js";import"./index-DEhQiHRI.js";import"./x-D7kv7_oa.js";import"./file-text-D4ZH2B6r.js";import"./building-2-B8zwlaZI.js";import"./users-Cw2EaZtR.js";import"./package-DX_4eLNa.js";import"./LanguageSwitcher-JaZwuRsp.js";import"./globe-BnAvlmAt.js";import"./ThemeToggle-IPjgC8LT.js";import"./circle-alert-nT1vmDMj.js";import"./checkbox-DSt0QHsS.js";import"./index-CENxNQLL.js";import"./trash-2-Dreerc3R.js";import"./badge-C9h6T3rK.js";import"./arrow-up-down-1q5LzOz0.js";import"./ellipsis-yQlqSxW1.js";import"./chevron-left-BEvpDX_2.js";function es({payments:I,suppliers:L,bankAccounts:O}){const[B,v]=m.useState(!1),[b,g]=m.useState([]),[N,x]=m.useState({}),[R,F]=m.useState(!1),{t:c}=xe(),{data:a,setData:i,post:M,processing:H,errors:t,reset:V}=U({supplier_id:"",bank_account_id:"",date:new Date,reference_number:"",amount:0,notes:"",payment_method:"Bank Transfer",allocations:[]}),y=a.supplier_id,h=a.amount;m.useEffect(()=>{y?(F(!0),$.get(route("purchase.suppliers.outstanding-invoices",y)).then(s=>{g(s.data),x({})}).catch(s=>{console.error("Failed to fetch invoices",s),g([])}).finally(()=>F(!1))):(g([]),x({}))},[y]);const E=()=>{let s=h;const n={};b.forEach(r=>{if(s>0){const d=Math.min(parseFloat(r.outstanding_amount.toString()),s);n[r.id]=parseFloat(d.toFixed(2)),s-=d}}),x(n)},q=s=>{s.preventDefault();const n=Object.entries(N).map(([r,d])=>({invoice_id:parseInt(r),amount:d})).filter(r=>r.amount>0);a.allocations=n,M(route("purchase.payments.store"),{onSuccess:()=>{v(!1),V(),x({}),g([])}})},_=Object.values(N).reduce((s,n)=>s+n,0),Q=h-_,z=m.useMemo(()=>W(c),[c]);return e.jsxs(J,{header:c("payments.title"),children:[e.jsx(G,{title:c("payments.title")}),e.jsxs("div",{className:"flex-1 space-y-4 p-8 pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between space-y-2",children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:c("payments.vouchers")}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs(X,{open:B,onOpenChange:v,children:[e.jsx(Y,{asChild:!0,children:e.jsxs(p,{children:[e.jsx(he,{className:"mr-2 h-4 w-4"}),c("payments.new")]})}),e.jsxs(Z,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ee,{children:[e.jsx(se,{children:"New Payment Voucher"}),e.jsx(ae,{children:"Record a payment to a supplier and allocate to invoices."})]}),e.jsxs("form",{onSubmit:q,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"supplier_id",children:"Supplier"}),e.jsxs(S,{value:a.supplier_id,onValueChange:s=>i("supplier_id",s),children:[e.jsx(w,{children:e.jsx(D,{placeholder:"Select supplier"})}),e.jsx(T,{children:L?.map(s=>e.jsx(l,{value:s.id.toString(),children:s.name},s.id))})]}),t.supplier_id&&e.jsx("p",{className:"text-sm text-red-500",children:t.supplier_id})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"bank_account_id",children:"Pay From (Bank/Cash)"}),e.jsxs(S,{value:a.bank_account_id,onValueChange:s=>i("bank_account_id",s),children:[e.jsx(w,{children:e.jsx(D,{placeholder:"Select account"})}),e.jsx(T,{children:O?.map(s=>e.jsxs(l,{value:s.id.toString(),children:[s.bank_name," - ",s.account_number||"Cash"]},s.id))})]}),t.bank_account_id&&e.jsx("p",{className:"text-sm text-red-500",children:t.bank_account_id})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:"Date"}),e.jsxs(re,{children:[e.jsx(le,{asChild:!0,children:e.jsxs(p,{variant:"outline",className:k("w-full pl-3 text-left font-normal",!a.date&&"text-muted-foreground"),children:[a.date?A(a.date,"PPP"):e.jsx("span",{children:"Pick a date"}),e.jsx(pe,{className:"ml-auto h-4 w-4 opacity-50"})]})}),e.jsx(ie,{className:"w-auto p-0",align:"start",children:e.jsx(oe,{mode:"single",selected:a.date,onSelect:s=>s&&i("date",s),initialFocus:!0})})]}),t.date&&e.jsx("p",{className:"text-sm text-red-500",children:t.date})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"reference_number",children:"Reference / Cheque No."}),e.jsx(C,{id:"reference_number",value:a.reference_number,onChange:s=>i("reference_number",s.target.value)}),t.reference_number&&e.jsx("p",{className:"text-sm text-red-500",children:t.reference_number})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"amount",children:"Amount"}),e.jsx(C,{type:"number",step:"0.01",id:"amount",value:a.amount,onChange:s=>i("amount",parseFloat(s.target.value))}),t.amount&&e.jsx("p",{className:"text-sm text-red-500",children:t.amount})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"payment_method",children:"Method"}),e.jsxs(S,{value:a.payment_method,onValueChange:s=>i("payment_method",s),children:[e.jsx(w,{children:e.jsx(D,{placeholder:"Select method"})}),e.jsxs(T,{children:[e.jsx(l,{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx(l,{value:"Cash",children:"Cash"}),e.jsx(l,{value:"Cheque",children:"Cheque"}),e.jsx(l,{value:"Credit Card",children:"Credit Card"}),e.jsx(l,{value:"DuitNow/QR",children:"DuitNow/QR"}),e.jsx(l,{value:"Online Transfer",children:"Online Transfer"})]})]}),t.payment_method&&e.jsx("p",{className:"text-sm text-red-500",children:t.payment_method})]}),e.jsxs("div",{className:"col-span-1 md:col-span-2 space-y-2",children:[e.jsx(o,{htmlFor:"notes",children:"Notes"}),e.jsx(ne,{id:"notes",value:a.notes,onChange:s=>i("notes",s.target.value)})]})]}),y&&e.jsxs("div",{className:"border rounded-md p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Allocate Payment"}),e.jsx(p,{type:"button",variant:"secondary",size:"sm",onClick:E,disabled:h<=0,children:"Auto Allocate"})]}),R?e.jsxs("div",{className:"text-center py-4 flex items-center justify-center",children:[e.jsx(ue,{className:"h-6 w-6 animate-spin mr-2"}),"Loading invoices..."]}):b.length===0?e.jsx("div",{className:"text-center py-4 text-muted-foreground",children:"No unpaid invoices found."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(P,{children:[e.jsx(j,{children:"Invoice No"}),e.jsx(j,{children:"Date"}),e.jsx(j,{className:"text-right",children:"Total"}),e.jsx(j,{className:"text-right",children:"Outstanding"}),e.jsx(j,{className:"w-[150px] text-right",children:"Allocation"})]})}),e.jsx(me,{children:b.map(s=>e.jsxs(P,{children:[e.jsx(f,{className:"font-medium",children:s.reference_number}),e.jsx(f,{children:A(new Date(s.date),"dd/MM/yyyy")}),e.jsx(f,{className:"text-right",children:u(parseFloat(s.total.toString()))}),e.jsx(f,{className:"text-right font-bold text-red-600",children:u(parseFloat(s.outstanding_amount.toString()))}),e.jsx(f,{children:e.jsx(C,{type:"number",step:"0.01",className:"text-right h-8",value:N[s.id]||"",onChange:n=>{const r=parseFloat(n.target.value)||0;x(d=>({...d,[s.id]:Math.min(r,parseFloat(s.outstanding_amount.toString()))}))}})})]},s.id))})]}),e.jsxs("div",{className:"flex justify-end gap-6 text-sm border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between w-48",children:[e.jsx("span",{children:"Payment Amount:"}),e.jsx("span",{className:"font-bold",children:u(h)})]}),e.jsxs("div",{className:"flex justify-between w-48",children:[e.jsx("span",{children:"Allocated:"}),e.jsx("span",{className:k("font-bold",_>h?"text-red-500":"text-green-600"),children:u(_)})]}),e.jsxs("div",{className:"flex justify-between w-48",children:[e.jsx("span",{children:"Unallocated:"}),e.jsx("span",{className:"font-bold",children:u(Q)})]})]})]})]}),e.jsxs(te,{children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>v(!1),children:"Cancel"}),e.jsx(p,{type:"submit",disabled:H,children:"Record Payment"})]})]})]})]})})]}),e.jsx("div",{className:"hidden h-full flex-1 flex-col space-y-8 md:flex",children:e.jsx(K,{columns:z,data:I.data})})]})]})}export{es as default};
